package codes.simen.l50notifications;

import android.app.KeyguardManager;
import android.app.Service;
import android.content.BroadcastReceiver;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.IBinder;
import android.preference.PreferenceManager;
import android.util.Log;

import codes.simen.l50notifications.util.OffReceiver;

public class KeyguardRelock extends Service {

    public KeyguardRelock() {
        super();
    }

    @Override
    public IBinder onBind(Intent intent) {
        return null; // not bindable
    }

    BroadcastReceiver mReceiver;
    KeyguardManager keyguardManager;
    KeyguardManager.KeyguardLock keyguardLock = null;

    @Override
    public int onStartCommand(Intent intent, int flags, int startid) {
        super.onStartCommand(intent, flags, startid);

        if (intent != null) {
            final String action = intent.getAction();
            Log.d("KeyguardRelock", action);

            if      (Intent.ACTION_SCREEN_ON.equals(action))  waitForLock();
            else if (Intent.ACTION_SCREEN_OFF.equals(action)) doLock();
            else                                              stopSelf();
        }
        return START_NOT_STICKY;
    }

    private void waitForLock() {
        keyguardManager = (KeyguardManager) getSystemService(KEYGUARD_SERVICE);
        keyguardLock = keyguardManager.newKeyguardLock("heads-up");
        try {
            keyguardLock.disableKeyguard();

            IntentFilter intentFilter = new IntentFilter(Intent.ACTION_SCREEN_OFF);
            mReceiver = new OffReceiver();
            registerReceiver(mReceiver, intentFilter);
        } catch (SecurityException se) {
            keyguardLock = null;
            PreferenceManager.getDefaultSharedPreferences(getApplicationContext())
                    .edit()
                    .putBoolean("dismiss_keyguard", false)
                    .apply();
            stopSelf();
        }
    }

    private void doLock() {
        unregisterReceiver(mReceiver);
        keyguardLock.reenableKeyguard();
        keyguardLock = null;
        stopSelf();
    }

    @Override
    public void onDestroy () {
        super.onDestroy();
        if (keyguardLock != null) {
            unregisterReceiver(mReceiver);
            keyguardLock.reenableKeyguard();
            keyguardLock = null;
        }
    }

}
